{% extends "base.html" %}

{% block title %}Community Chat - MyViolinRep{% endblock %}

{% block content %}
<!-- Chat Header -->
<section class="chat-header">
    <div class="container">
        <div class="header-content">
            <h1 class="page-title">Community Chat</h1>
            <p class="page-subtitle">Connect with fellow violinists in real-time</p>
        </div>
    </div>
</section>

<!-- Chat Interface -->
<section class="chat-interface">
    <div class="container">
        <div class="chat-container">
            <!-- Chat Sidebar -->
            <div class="chat-sidebar">
                <div class="sidebar-header">
                    <h3><i class="fas fa-users"></i> Online Members</h3>
                    <span class="online-count" id="online-count">3 online</span>
                </div>
                
                <div class="online-members" id="online-members">
                    <!-- Members will be populated dynamically -->
                </div>
                
                <div class="sidebar-footer">
                    <div class="chat-rooms">
                        <h4>Chat Rooms</h4>
                        <div class="room-list" id="room-list">
                            <div class="room-item active" data-room="general">
                                <i class="fas fa-hashtag"></i>
                                <span>General</span>
                            </div>
                            <div class="room-item" data-room="technique">
                                <i class="fas fa-hashtag"></i>
                                <span>Technique Tips</span>
                            </div>
                            <div class="room-item" data-room="repertoire">
                                <i class="fas fa-hashtag"></i>
                                <span>Repertoire Discussion</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="direct-messages">
                        <h4>Direct Messages</h4>
                        <div class="dm-disabled-notice">
                            <i class="fas fa-info-circle"></i>
                            <span>Coming soon - use group chat for now</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Chat Main -->
            <div class="chat-main">
                <div class="chat-header-bar">
                    <div class="current-room">
                        <i class="fas fa-hashtag"></i>
                        <span id="current-room-name">General</span>
                    </div>
                    <div class="chat-actions">
                        <button class="action-btn" id="search-btn" title="Search Messages">
                            <i class="fas fa-search"></i>
                        </button>
                        <button class="action-btn" id="settings-btn" title="Chat Settings">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button class="action-btn" id="faq-btn" title="Chat FAQ">
                            <i class="fas fa-question-circle"></i>
                        </button>
                        {% if current_user.username == 'admin' %}
                            <button class="action-btn admin-btn" id="admin-panel-btn" title="Admin Panel">
                                <i class="fas fa-shield-alt"></i>
                            </button>
                        {% endif %}
                    </div>
                </div>
                
                <div class="chat-messages" id="chat-messages">
                    <!-- Messages will be populated here -->
                </div>
                
                <div class="chat-input">
                    <form id="chat-form" class="input-form" onsubmit="event.preventDefault(); sendMessage();">
                        <div class="input-wrapper">
                            <input type="text" id="message-input" placeholder="Type your message..." maxlength="500">
                            <div class="input-actions">
                                <button type="button" class="action-btn" title="Emoji" id="emoji-btn" onclick="toggleEmojiPicker()">
                                    <i class="fas fa-smile"></i>
                                </button>
                                <button type="button" class="action-btn" title="Attach" id="attach-btn" onclick="toggleAttachmentMenu()">
                                    <i class="fas fa-paperclip"></i>
                                </button>
                                <button type="submit" class="send-btn">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </form>
                    
                    <!-- Hidden file input for attachments -->
                    <input type="file" id="file-input" style="display: none;" accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt" multiple>
                    

                </div>
            </div>
        </div>
    </div>
</section>

<!-- Search Modal -->
<div id="search-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Search Messages</h3>
            <button class="close-modal" onclick="closeSearchModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="search-form">
                <input type="text" id="message-search" placeholder="Search for messages..." class="search-input">
                <button class="btn btn-primary" onclick="searchMessages()">Search</button>
            </div>
            <div class="search-results" id="message-search-results">
                <!-- Search results will appear here -->
            </div>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div id="settings-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Chat Settings</h3>
            <button class="close-modal" onclick="closeSettingsModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="settings-section">
                <h4>Notifications</h4>
                <label class="setting-item">
                    <input type="checkbox" id="sound-notifications" checked>
                    <span>Sound notifications</span>
                </label>
                <label class="setting-item">
                    <input type="checkbox" id="desktop-notifications">
                    <span>Desktop notifications</span>
                </label>
            </div>
            <div class="settings-section">
                <h4>Display</h4>
                <label class="setting-item">
                    <input type="checkbox" id="compact-mode">
                    <span>Compact mode</span>
                </label>
                <label class="setting-item">
                    <input type="checkbox" id="show-timestamps" checked>
                    <span>Show timestamps</span>
                </label>
            </div>
            <div class="settings-section">
                <h4>Privacy</h4>
                <label class="setting-item">
                    <input type="checkbox" id="show-online-status" checked>
                    <span>Show online status</span>
                </label>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
        </div>
    </div>
</div>

<!-- Admin Panel Modal -->
<div id="admin-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Admin Panel</h3>
            <button class="close-modal" onclick="closeAdminModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="admin-section">
                <h4>Message Management</h4>
                <div class="admin-actions">
                    <button class="btn btn-danger" onclick="clearAllMessages()">Clear All Messages</button>
                    <button class="btn btn-warning" onclick="muteUser()">Mute User</button>
                </div>
            </div>
            <div class="admin-section">
                <h4>User Management</h4>
                <div class="admin-actions">
                    <button class="btn btn-warning" onclick="banUser()">Ban User</button>
                    <button class="btn btn-info" onclick="viewUserLogs()">View User Logs</button>
                </div>
            </div>
        </div>
    </div>
</div>



<!-- Chat FAQ Modal -->
<div id="chat-faq-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Chat Features & FAQ</h3>
            <button class="close-modal" onclick="closeChatFAQ()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="faq-section">
                <h4><i class="fas fa-bolt"></i> Real-time Messaging</h4>
                <p>Instant communication with fellow violinists around the world. Messages update every 2 seconds for real-time conversation.</p>
            </div>
            
            <div class="faq-section">
                <h4><i class="fas fa-users"></i> Chat Rooms</h4>
                <p><strong>General:</strong> Open discussions about anything violin-related<br>
                <strong>Technique Tips:</strong> Share and discuss playing techniques<br>
                <strong>Repertoire Discussion:</strong> Talk about pieces, composers, and interpretations</p>
            </div>
            
            <div class="faq-section">
                <h4><i class="fas fa-smile"></i> Emojis & Attachments</h4>
                <p><strong>Emoji Button:</strong> Click the smiley face to add emojis to your messages<br>
                <strong>Attachment Button:</strong> Click the paperclip to share:<br>
                ‚Ä¢ Images (üñºÔ∏è)<br>
                ‚Ä¢ YouTube Videos (üé•)<br>
                ‚Ä¢ Spotify Tracks (üéµ)<br>
                ‚Ä¢ Sheet Music (üìú)</p>
            </div>
            
            <div class="faq-section">
                <h4><i class="fas fa-info-circle"></i> Direct Messages</h4>
                <p>Direct messaging is temporarily disabled. Please use the group chat rooms for discussions. This feature will be available in an upcoming update!</p>
            </div>
            
            <div class="faq-section">
                <h4><i class="fas fa-shield-alt"></i> Safe Environment</h4>
                <p>Our chat is moderated to ensure respectful and helpful discussions. Please be kind and constructive in your conversations.</p>
            </div>
            
            <div class="faq-section">
                <h4><i class="fas fa-mobile-alt"></i> Mobile Friendly</h4>
                <p>Chat works on any device - desktop, tablet, or mobile. The interface adapts to your screen size automatically.</p>
            </div>
        </div>
    </div>
</div>

<!-- Emoji Selection Modal -->
<div id="emoji-modal" class="modal">
    <div class="modal-content emoji-modal-content">
        <div class="modal-header">
            <h3>Choose an Emoji</h3>
            <button class="close-modal" onclick="closeEmojiModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="emoji-grid" id="emoji-modal-list">
                <!-- Emojis will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Attachment Selection Modal -->
<div id="attachment-modal" class="modal">
    <div class="modal-content attachment-modal-content">
        <div class="modal-header">
            <h3>Add Attachment</h3>
            <button class="close-modal" onclick="closeAttachmentModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="attachment-options">
                <div class="attachment-option" onclick="openFilePicker('image')">
                    <i class="fas fa-folder-open"></i>
                    <span>Upload Image</span>
                    <p>Select an image from your device</p>
                </div>
                <div class="attachment-option" onclick="openFilePicker('video')">
                    <i class="fas fa-video"></i>
                    <span>Upload Video</span>
                    <p>Select a video from your device</p>
                </div>
                <div class="attachment-option" onclick="openFilePicker('audio')">
                    <i class="fas fa-music"></i>
                    <span>Upload Audio</span>
                    <p>Select an audio file from your device</p>
                </div>
                <div class="attachment-option" onclick="openFilePicker('document')">
                    <i class="fas fa-file-alt"></i>
                    <span>Upload Document</span>
                    <p>Select a document from your device</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.chat-header {
    background: linear-gradient(135deg, #8B0000, #DAA520);
    color: white;
    padding: 3rem 0;
    text-align: center;
}

.chat-header .container {
    position: relative;
    z-index: 2;
}

@keyframes gradientShift {
    0% {
        background-position: 0% 50%;
    }
    50% {
        background-position: 100% 50%;
    }
    100% {
        background-position: 0% 50%;
    }
}

.page-title {
    font-size: 3rem;
    margin-bottom: 1rem;
}

.page-subtitle {
    font-size: 1.25rem;
    opacity: 0.9;
}

.chat-interface {
    padding: 2rem 0;
    background: #f8f9fa;
    min-height: 70vh;
}

.chat-container {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 2rem;
    max-width: 1200px;
    margin: 0 auto;
    background: white;
    border-radius: 16px;
    box-shadow: 0 8px 40px rgba(0, 0, 0, 0.1);
    overflow: hidden;
}

.chat-sidebar {
    background: #f8f9fa;
    border-right: 1px solid #e9ecef;
    display: flex;
    flex-direction: column;
}

.sidebar-header {
    padding: 1.5rem;
    border-bottom: 1px solid #e9ecef;
    background: white;
}

.sidebar-header h3 {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin: 0 0 0.5rem 0;
    color: #2c3e50;
    font-size: 1.125rem;
}

.sidebar-header h3 i {
    color: #8B0000;
}

.online-count {
    color: #28a745;
    font-size: 0.875rem;
    font-weight: 600;
}

.online-members {
    padding: 1rem;
    flex: 1;
}

.member-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem;
    border-radius: 8px;
    transition: background-color 0.3s ease;
    cursor: pointer;
}

.member-item:hover {
    background: rgba(139, 0, 0, 0.05);
}

.member-item.online {
    background: rgba(40, 167, 69, 0.1);
}

.member-avatar {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #8B0000, #DAA520);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.25rem;
}

.member-info {
    display: flex;
    flex-direction: column;
    flex: 1;
}

.member-name {
    font-weight: 600;
    color: #2c3e50;
    font-size: 0.875rem;
}

.member-status {
    font-size: 0.75rem;
    color: #6c757d;
}

.member-status.online {
    color: #28a745;
}

.sidebar-footer {
    padding: 1rem;
    border-top: 1px solid #e9ecef;
    background: white;
}

.chat-rooms h4, .direct-messages h4 {
    margin: 0 0 1rem 0;
    color: #2c3e50;
    font-size: 1rem;
}

.room-list, .dm-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
}

.room-item, .dm-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    color: #6c757d;
}

.room-item:hover, .dm-item:hover {
    background: rgba(139, 0, 0, 0.05);
    color: #8B0000;
}

.room-item.active, .dm-item.active {
    background: linear-gradient(135deg, #8B0000, #DAA520);
    color: white;
}

.room-item i, .dm-item i {
    font-size: 0.875rem;
}

.dm-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.2s ease;
    margin-bottom: 0.5rem;
}

.dm-item:hover {
    background-color: rgba(139, 0, 0, 0.1);
}

.dm-item.active {
    background-color: rgba(139, 0, 0, 0.2);
    border-left: 3px solid #8B0000;
}

.dm-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: #8B0000;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1rem;
}

.dm-info {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.dm-name {
    font-weight: 600;
    color: #2c3e50;
    font-size: 0.875rem;
}

.dm-status {
    font-size: 0.75rem;
    color: #6c757d;
}

.no-dms {
    padding: 1rem;
    text-align: center;
    color: #6c757d;
    font-style: italic;
    font-size: 0.875rem;
}

.dm-search {
    position: relative;
    margin-bottom: 1rem;
}

.dm-search-input {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    font-size: 0.875rem;
}

.search-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    max-height: 300px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
}

.search-result-item {
    padding: 1rem;
    border-bottom: 1px solid #f8f9fa;
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.search-result-item:hover {
    background-color: #f8f9fa;
}

.search-result-item:last-child {
    border-bottom: none;
}

.search-result-item .user-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.5rem;
}

.search-result-item .username {
    font-weight: 600;
    color: #2c3e50;
}

.search-result-item .user-bio {
    font-size: 0.875rem;
    color: #6c757d;
    margin-left: 1.75rem;
}

.no-results {
    padding: 1rem;
    text-align: center;
    color: #6c757d;
    font-style: italic;
}

.chat-main {
    display: flex;
    flex-direction: column;
    height: 600px;
}

.chat-header-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #e9ecef;
    background: white;
}

.current-room {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-weight: 600;
    color: #2c3e50;
}

.current-room i {
    color: #8B0000;
}

.chat-actions {
    display: flex;
    gap: 0.5rem;
}

.action-btn {
    background: none;
    border: none;
    padding: 0.5rem;
    border-radius: 8px;
    cursor: pointer;
    color: #6c757d;
    transition: all 0.3s ease;
}

.action-btn:hover {
    background: rgba(139, 0, 0, 0.05);
    color: #8B0000;
}

.message-actions {
    display: flex;
    gap: 0.5rem;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.message:hover .message-actions {
    opacity: 1;
}

.admin-btn {
    color: #dc3545;
}

.admin-btn:hover {
    background: rgba(220, 53, 69, 0.1);
}

.chat-messages {
    flex: 1;
    padding: 1.5rem;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.message-item {
    display: flex;
    gap: 1rem;
    align-items: flex-start;
}

.message-item.own-message {
    flex-direction: row-reverse;
}

.message-avatar {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #8B0000, #DAA520);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.25rem;
    flex-shrink: 0;
}

.message-content {
    flex: 1;
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 12px;
    border-top-left-radius: 4px;
    position: relative;
}

.own-message .message-content {
    background: linear-gradient(135deg, #8B0000, #DAA520);
    color: white;
    border-top-left-radius: 12px;
    border-top-right-radius: 4px;
}

.message-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.message-author {
    font-weight: 600;
    color: #8B0000;
    font-size: 0.875rem;
    cursor: pointer;
}

.own-message .message-author {
    color: white;
}

.message-time {
    font-size: 0.75rem;
    color: #6c757d;
}

.own-message .message-time {
    color: rgba(255, 255, 255, 0.8);
}

.message-text {
    color: #2c3e50;
    line-height: 1.5;
    margin: 0;
}

.own-message .message-text {
    color: white;
}

.message-actions {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    display: none;
    gap: 0.25rem;
}

.message-content:hover .message-actions {
    display: flex;
}

.message-action-btn {
    background: rgba(255, 255, 255, 0.9);
    border: none;
    border-radius: 4px;
    padding: 0.25rem;
    cursor: pointer;
    font-size: 0.75rem;
    color: #6c757d;
}

.message-action-btn:hover {
    background: white;
    color: #8B0000;
}

.chat-input {
    padding: 1rem 1.5rem;
    border-top: 1px solid #e9ecef;
    background: white;
}

.input-form {
    margin: 0;
}

.input-wrapper {
    display: flex;
    align-items: center;
    gap: 1rem;
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    border-radius: 25px;
    padding: 0.75rem 1rem;
    transition: border-color 0.3s ease;
}

.input-wrapper:focus-within {
    border-color: #8B0000;
}

#message-input {
    flex: 1;
    border: none;
    background: none;
    outline: none;
    font-size: 1rem;
    color: #2c3e50;
}

.input-actions {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.send-btn {
    background: linear-gradient(135deg, #8B0000, #DAA520);
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: white;
    transition: transform 0.3s ease;
}

.send-btn:hover {
    transform: scale(1.05);
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
}

.modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 0;
    border-radius: 16px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 16px 60px rgba(0, 0, 0, 0.3);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem 2rem;
    border-bottom: 1px solid #e9ecef;
}

.modal-header h3 {
    margin: 0;
    color: #2c3e50;
}

.close-modal {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #6c757d;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background-color 0.3s ease;
}

.close-modal:hover {
    background: #f8f9fa;
    color: #8B0000;
}

.modal-body {
    padding: 2rem;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    padding: 1.5rem 2rem;
    border-top: 1px solid #e9ecef;
    background: #f8f9fa;
}

/* Search Form */
.search-form {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.search-input {
    flex: 1;
    padding: 0.75rem;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 1rem;
}

/* Settings */
.settings-section {
    margin-bottom: 2rem;
}

.settings-section h4 {
    margin: 0 0 1rem 0;
    color: #2c3e50;
}

.setting-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
    cursor: pointer;
}

.setting-item input[type="checkbox"] {
    width: 18px;
    height: 18px;
}

/* Admin Panel */
.admin-section {
    margin-bottom: 2rem;
}

.admin-section h4 {
    margin: 0 0 1rem 0;
    color: #2c3e50;
}

.admin-actions {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

/* Emoji Picker Styles */
.emoji-picker {
    position: absolute;
    bottom: 100%;
    left: 0;
    width: 320px;
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 12px;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
    z-index: 1000;
    display: none;
    margin-bottom: 10px;
}

.emoji-picker.show {
    display: block;
    animation: slideUp 0.3s ease;
}

@keyframes slideUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.emoji-categories {
    display: flex;
    border-bottom: 1px solid #e9ecef;
    padding: 0.5rem;
    gap: 0.25rem;
}

.emoji-category {
    background: none;
    border: none;
    padding: 0.5rem;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1.25rem;
    transition: all 0.3s ease;
}

.emoji-category:hover {
    background: #f8f9fa;
}

.emoji-category.active {
    background: #8B0000;
    color: white;
}

.emoji-grid {
    padding: 1rem;
    max-height: 200px;
    overflow-y: auto;
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    gap: 0.5rem;
}

.emoji-item {
    background: none;
    border: none;
    padding: 0.5rem;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1.5rem;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.emoji-item:hover {
    background: #f8f9fa;
    transform: scale(1.1);
}

/* Attachment Menu Styles */
.attachment-menu {
    position: absolute;
    bottom: 100%;
    right: 0;
    width: 200px;
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 12px;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
    z-index: 1000;
    display: none;
    margin-bottom: 10px;
    overflow: hidden;
}

.attachment-menu.show {
    display: block;
    animation: slideUp 0.3s ease;
}

.attachment-option {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    border-bottom: 1px solid #f8f9fa;
}

.attachment-option:last-child {
    border-bottom: none;
}

.attachment-option:hover {
    background: #f8f9fa;
    color: #8B0000;
}

.attachment-option i {
    font-size: 1.125rem;
    width: 20px;
    text-align: center;
}

.attachment-option span {
    font-size: 0.875rem;
    font-weight: 500;
}



@media (max-width: 768px) {
    .chat-container {
        grid-template-columns: 1fr;
        gap: 0;
    }
    
    .chat-sidebar {
        order: 2;
        border-right: none;
        border-top: 1px solid #e9ecef;
    }
    
    .chat-main {
        order: 1;
        height: 400px;
    }
    
    .page-title {
        font-size: 2rem;
    }
}

/* Emoji Picker */
#emoji-picker {
    position: absolute;
    bottom: 100%;
    left: 0;
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    padding: 1rem;
    max-width: 300px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
    margin-bottom: 10px;
}

#emoji-list {
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    gap: 0.5rem;
}

.emoji {
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0.25rem;
    border-radius: 4px;
    transition: background-color 0.2s ease;
    text-align: center;
    user-select: none;
}

.emoji:hover {
    background-color: #f8f9fa;
}

/* Attachment Menu */
#attachment-menu {
    position: absolute;
    bottom: 100%;
    right: 0;
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    padding: 1rem;
    min-width: 200px;
    z-index: 1000;
    display: none;
    margin-bottom: 10px;
}

.attachment-option {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    cursor: pointer;
    border-radius: 4px;
    transition: background-color 0.2s ease;
}

.attachment-option:hover {
    background-color: #f8f9fa;
}

.attachment-option i {
    font-size: 1.25rem;
    color: #8B0000;
}

/* Enhanced Search Results */
.search-result-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    cursor: pointer;
    border-radius: 8px;
    transition: all 0.2s ease;
    border-bottom: 1px solid #f0f0f0;
}

.search-result-item:hover {
    background-color: #f8f9fa;
    transform: translateX(4px);
}

.search-result-item .user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    overflow: hidden;
    flex-shrink: 0;
}

.search-result-item .user-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.search-result-item .user-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.search-result-item .username {
    font-weight: 600;
    color: #2c3e50;
    font-size: 0.9rem;
}

.search-result-item .user-bio {
    font-size: 0.8rem;
    color: #6c757d;
    line-height: 1.2;
}

.search-result-item .start-chat-btn {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: #8B0000;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    transition: all 0.2s ease;
}

.search-result-item:hover .start-chat-btn {
    background: #a52a2a;
    transform: scale(1.1);
}

/* Enhanced DM Items */
.dm-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    cursor: pointer;
    border-radius: 8px;
    transition: all 0.2s ease;
    border-bottom: 1px solid #f0f0f0;
    position: relative;
}

.dm-item:hover {
    background-color: #f8f9fa;
}

.dm-item.active {
    background-color: #e3f2fd;
    border-left: 3px solid #8B0000;
}

.dm-item .dm-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    overflow: hidden;
    flex-shrink: 0;
}

.dm-item .dm-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.dm-item .dm-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.dm-item .dm-name {
    font-weight: 600;
    color: #2c3e50;
    font-size: 0.9rem;
}

.dm-item .dm-status {
    font-size: 0.75rem;
    color: #6c757d;
    line-height: 1.2;
    max-width: 150px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.dm-item .dm-indicator {
    position: relative;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.dm-item .dm-indicator i {
    font-size: 0.6rem;
    color: #6c757d;
    transition: all 0.2s ease;
}

.dm-item .dm-indicator i.unread {
    color: #e74c3c;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.no-dms {
    text-align: center;
    padding: 1rem;
    color: #6c757d;
    font-style: italic;
}

.no-results {
    text-align: center;
    padding: 1rem;
    color: #6c757d;
    font-style: italic;
}

/* Ensure proper positioning for input actions */
.input-actions {
    position: relative;
}

#emoji-btn, #attach-btn {
    position: relative;
}

/* DM Disabled Notice - Compact */
.dm-disabled-notice {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    padding: 0.5rem 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 0.5rem 0;
    font-size: 0.75rem;
    color: #6c757d;
}

.dm-disabled-notice i {
    color: #8B0000;
    font-size: 0.875rem;
}

/* Message Links */
.message-link {
    color: #8B0000;
    text-decoration: underline;
    font-weight: 600;
    transition: color 0.3s ease;
}

.message-link:hover {
    color: #DAA520;
    text-decoration: none;
}

.own-message .message-link {
    color: #FFD700;
}

.own-message .message-link:hover {
    color: #FFFFFF;
}



/* FAQ Modal */
.faq-section {
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #e9ecef;
}

.faq-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.faq-section h4 {
    color: #8B0000;
    font-size: 1rem;
    margin: 0 0 0.5rem 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.faq-section h4 i {
    color: #DAA520;
}

.faq-section p {
    color: #6c757d;
    line-height: 1.6;
    margin: 0;
}

.faq-section strong {
    color: #2c3e50;
}

/* Emoji Modal */
.emoji-modal-content {
    max-width: 500px;
    max-height: 80vh;
}

.emoji-grid {
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    gap: 10px;
    max-height: 400px;
    overflow-y: auto;
    padding: 10px;
}

.emoji-grid .emoji {
    font-size: 1.5rem;
    padding: 8px;
    text-align: center;
    cursor: pointer;
    border-radius: 8px;
    transition: background-color 0.2s;
}

.emoji-grid .emoji:hover {
    background-color: #f0f0f0;
}

/* Attachment Modal */
.attachment-modal-content {
    max-width: 400px;
}

.attachment-options {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    padding: 20px;
}

.attachment-option {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
}

.attachment-option:hover {
    border-color: #8B0000;
    background-color: #f8f8f8;
    transform: translateY(-2px);
}

.attachment-option i {
    font-size: 2rem;
    margin-bottom: 10px;
    color: #8B0000;
}

.attachment-option span {
    font-weight: 600;
    margin-bottom: 5px;
    color: #333;
}

.attachment-option p {
    font-size: 0.85rem;
    color: #666;
    margin: 0;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Chat state
let currentRoom = 'general';
let currentDM = null;
let messages = [];
let onlineUsers = [];
let currentUser = '{{ current_user.username if current_user else "" }}';
console.log('currentUser variable set to:', currentUser);
let chatSettings = {
    soundNotifications: true,
    desktopNotifications: false,
    compactMode: false,
    showTimestamps: true,
    showOnlineStatus: true
};

// Switch room
function switchRoom(roomName) {
    currentRoom = roomName;
    currentDM = null;
    
    // Update UI
    document.querySelectorAll('.room-item').forEach(item => item.classList.remove('active'));
    document.querySelector(`[data-room="${roomName}"]`).classList.add('active');
    document.getElementById('current-room-name').innerHTML = `<i class="fas fa-hashtag"></i> ${roomName}`;
    
    // Clear chat
    document.getElementById('chat-messages').innerHTML = '';
    
    // Add welcome message
    addSystemMessage(`Joined #${roomName}`);
    
    // Load room messages
    loadMessages(roomName);
}

// Initialize chat
document.addEventListener('DOMContentLoaded', function() {
    console.log('Chat page loaded, currentUser:', currentUser);
    console.log('Setting up event listeners...');
    
    // Test if functions are accessible
    console.log('toggleEmojiPicker function:', typeof toggleEmojiPicker);
    console.log('toggleAttachmentMenu function:', typeof toggleAttachmentMenu);
    
    // Add click-outside-to-close functionality for emoji picker and attachment menu
    document.addEventListener('click', function(event) {
        const emojiPicker = document.getElementById('emoji-picker');
        const attachmentMenu = document.getElementById('attachment-menu');
        const emojiBtn = document.getElementById('emoji-btn');
        const attachBtn = document.getElementById('attach-btn');
        
        // Close emoji picker if clicking outside
        if (emojiPicker && emojiPicker.style.display === 'block') {
            if (!emojiPicker.contains(event.target) && !emojiBtn.contains(event.target)) {
                emojiPicker.style.display = 'none';
            }
        }
        
        // Close attachment menu if clicking outside
        if (attachmentMenu && attachmentMenu.style.display === 'block') {
            if (!attachmentMenu.contains(event.target) && !attachBtn.contains(event.target)) {
                attachmentMenu.style.display = 'none';
            }
        }
    });
    
    // Check if we have a room parameter in the URL
    const urlParams = new URLSearchParams(window.location.search);
    const roomParam = urlParams.get('room');
    
    console.log('Room parameter from URL:', roomParam);
    
    if (roomParam && roomParam.startsWith('dm_')) {
        // DM rooms are disabled - redirect to general
        console.log('DM room detected but DMs are disabled - redirecting to general');
        showMessage('Direct messaging is temporarily disabled. Please use the group chat rooms instead. This feature will be available in an upcoming update!', 'info');
        switchRoom('general');
    } else if (roomParam) {
        console.log('Switching to room:', roomParam);
        // Switch to specific room
        switchRoom(roomParam);
    } else {
        console.log('No room parameter, defaulting to general');
        // Default to general room
        switchRoom('general');
    }
    
    // Load initial data
    loadOnlineUsers();
    
    // Set up room switching
    document.querySelectorAll('.room-item').forEach(item => {
        item.addEventListener('click', function() {
            const room = this.getAttribute('data-room');
            switchRoom(room);
        });
    });
    
    // DM search is disabled - no need to set up event listeners
    
    // Set up other event listeners
    setupEventListeners();
    
    // Start real-time updates
    startRealTimeUpdates();
});

// Event listeners
function setupEventListeners() {
    // Chat form submission
    document.getElementById('chat-form').addEventListener('submit', function(e) {
        e.preventDefault();
        sendMessage();
    });
    
    // Search button
    document.getElementById('search-btn').addEventListener('click', function() {
        openSearchModal();
    });
    
    // Settings button
    document.getElementById('settings-btn').addEventListener('click', function() {
        openSettingsModal();
    });
    
    // Admin panel button
    const adminBtn = document.getElementById('admin-panel-btn');
    if (adminBtn) {
        adminBtn.addEventListener('click', function() {
            openAdminModal();
        });
    }
    
    // FAQ button
    const faqBtn = document.getElementById('faq-btn');
    if (faqBtn) {
        faqBtn.addEventListener('click', function() {
            openChatFAQ();
        });
    }
    
    // DM search is disabled
    
    // Emoji and attachment buttons now use inline onclick handlers
}

// Start DM with user (DISABLED)
function startDM(username) {
    // Direct messaging is temporarily disabled
    showMessage('Direct messaging is temporarily disabled. Please use the group chat rooms (General, Technique Tips, or Repertoire Discussion) instead. This feature will be available in an upcoming update!', 'info');
    
    // Redirect to general chat instead
    switchRoom('general');
}

// Send message
function sendMessage() {
    const messageInput = document.getElementById('message-input');
    const content = messageInput.value.trim();
    
    if (!content) return;
    
    // Only group chat rooms are supported now
    const room = currentRoom;
    
    // Clear input immediately to prevent double-sending
    messageInput.value = '';
    
    fetch('/send_message', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            content: content,
            room: room
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Add message to chat immediately
            addMessage(currentUser, content, true, null, Date.now());
            
            // Reload messages to get the latest from server
            setTimeout(() => {
                loadMessages(room);
            }, 100);
            
            // DM functionality is disabled
            
            // Force immediate message refresh for real-time updates
            setTimeout(() => {
                loadMessages(room, true);
            }, 500);
        } else {
            showMessage('Error sending message: ' + data.message, 'error');
            // Restore message content if sending failed
            messageInput.value = content;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Error sending message. Please try again.', 'error');
        // Restore message content if sending failed
        messageInput.value = content;
    });
}

// Add message to chat
function addMessage(sender, content, isOwn, timestamp = null, messageId = null) {
    const chatMessages = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isOwn ? 'own-message' : 'other-message'}`;
    messageDiv.setAttribute('data-message-id', messageId || '');
    
    const time = timestamp || new Date().toLocaleTimeString('en-US', { 
        hour: 'numeric', 
        minute: '2-digit',
        hour12: true 
    });
    
    messageDiv.innerHTML = `
        <div class="message-header">
            <span class="message-sender">${sender}</span>
            <span class="message-time">${time}</span>
            ${isOwn || currentUser === 'admin' ? `
                <div class="message-actions">
                    ${isOwn ? `
                        <button class="action-btn" onclick="editMessage('${messageId}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                    ` : ''}
                    <button class="action-btn" onclick="deleteMessage('${messageId}')" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            ` : ''}
        </div>
        <div class="message-content">${formatMessageContent(content)}</div>
    `;
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Add system message
function addSystemMessage(text) {
    const chatMessages = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message-item system-message';
    
    messageDiv.innerHTML = `
        <div class="message-content system">
            <div class="message-text">${text}</div>
        </div>
    `;
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Handle new message from other user
function handleNewMessage(message) {
    // Only add if it's not from current user and not already displayed
    if (message.sender !== currentUser && !messages.some(m => m.id === message.id)) {
        messages.push(message);
        addMessage(message.sender, message.content, false, message.date_sent, message.id);
        
        // Play notification sound for new messages from others
        playNotificationSound();
        
        // Scroll to bottom to show new message
        const chatMessages = document.getElementById('chat-messages');
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
}

// Enhanced message loading with duplicate prevention
function loadMessages(room, silent = false) {
    if (!room) {
        console.log('loadMessages called with no room');
        return;
    }
    
    console.log('loadMessages called with room:', room, 'silent:', silent);
    
    fetch(`/get_messages/${room}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Messages loaded successfully for room:', room, 'count:', data.messages.length);
                const newMessages = data.messages;
                
                // Check if we have new messages
                let hasNewMessages = false;
                if (messages.length !== newMessages.length) {
                    hasNewMessages = true;
                } else {
                    // Check if any message IDs are different
                    for (let i = 0; i < Math.min(messages.length, newMessages.length); i++) {
                        if (messages[i]?.id !== newMessages[i]?.id) {
                            hasNewMessages = true;
                            break;
                        }
                    }
                }
                
                if (hasNewMessages) {
                    // Update the messages array
                    messages = newMessages;
                    
                    // Only redisplay if not silent (to avoid flickering)
                    if (!silent) {
                        displayMessages();
                    }
                    
                                // DM functionality is disabled
                    
                    // Play notification sound for new messages from others
                    if (!silent) {
                        const lastMessage = newMessages[newMessages.length - 1];
                        if (lastMessage && lastMessage.sender !== currentUser) {
                            playNotificationSound();
                        }
                    }
                }
            } else {
                console.error('Error loading messages for room:', room, 'Error:', data.message);
                if (!silent) {
                    addSystemMessage('Error loading messages: ' + data.message);
                }
            }
        })
        .catch(error => {
            console.error('Error loading messages for room:', room, 'Error:', error);
            if (!silent) {
                addSystemMessage('Error loading messages. Please try again.');
            }
        });
}

// Display messages
function displayMessages() {
    const chatMessages = document.getElementById('chat-messages');
    chatMessages.innerHTML = '';
    
    if (messages.length === 0) {
        addSystemMessage('No messages yet. Start the conversation!');
        return;
    }
    
    messages.forEach(msg => {
        addMessage(msg.sender, msg.content, msg.is_own, msg.date_sent, msg.id);
    });
    
    // Scroll to bottom
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Start real-time updates
function startRealTimeUpdates() {
    // Update online users every 60 seconds (reduced frequency to lower avatar calls)
    setInterval(loadOnlineUsers, 60000);
    
    // Update messages every 2 seconds for current room (more frequent for better responsiveness)
    setInterval(() => {
        if (currentRoom) {
            loadMessages(currentRoom, true); // silent update
        }
    }, 2000);
    
    // DM functionality is disabled - no need to update DM list
    
    // Also check for new messages when user becomes active
    document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
            // User became active, check for new messages
            if (currentRoom) {
                loadMessages(currentRoom, true);
            }
        }
    });
}

// Load online users and active DMs
function loadOnlineUsers() {
    // Get all online users from the server
    fetch('/get_online_users')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayOnlineUsers(data.users);
                // DM functionality is disabled
            }
        })
        .catch(error => {
            console.error('Error loading online users:', error);
            // Fallback to just showing current user
            displayOnlineUsers([{ username: currentUser, status: 'online' }]);
            // DM functionality is disabled
        });
}

// Display online users
function displayOnlineUsers(users) {
    const onlineMembers = document.getElementById('online-members');
    
    if (!onlineMembers) {
        console.log('online-members element not found, skipping displayOnlineUsers');
        return;
    }
    
    let html = '';
    users.forEach(user => {
        html += `
            <div class="member-item ${user.status}">
                <div class="member-avatar">
                    <i class="fas fa-user-circle"></i>
                </div>
                <div class="member-info">
                    <span class="member-name">${user.username}</span>
                    <span class="member-status">${user.status}</span>
                </div>
            </div>
        `;
    });
    
    onlineMembers.innerHTML = html;
    
    const onlineCount = document.getElementById('online-count');
    if (onlineCount) {
        onlineCount.textContent = `${users.length} online`;
    }
}

// Avatar cache to prevent multiple requests
let avatarCache = new Map();
let lastAvatarUpdate = 0;
const AVATAR_CACHE_DURATION = 60000; // 1 minute

// Load active DMs (DISABLED)
function loadActiveDMs() {
    // Direct messaging is temporarily disabled - no need to load DMs
    console.log('Direct messaging is disabled - skipping DM loading');
}

// Get cached avatar or return default
function getCachedAvatar(avatar, username) {
    const now = Date.now();
    
    // If we have a valid avatar and it's cached, use it
    if (avatar && avatarCache.has(avatar)) {
        return avatar;
    }
    
    // If no avatar or not cached, use default
    return '/static/images/default-avatar.png';
}

// Handle avatar loading errors with caching
function handleAvatarError(img, username) {
    const now = Date.now();
    
    // Only update default avatar once per minute to prevent spam
    if (now - lastAvatarUpdate > AVATAR_CACHE_DURATION) {
        img.src = '/static/images/default-avatar.png';
        lastAvatarUpdate = now;
        console.log(`Avatar error for ${username}, using default (cached for 1 minute)`);
    }
}

// Search users for DM (DISABLED)
function searchUsers(query) {
    // Direct messaging is temporarily disabled
    showMessage('Direct messaging is temporarily disabled. Please use the group chat rooms (General, Technique Tips, or Repertoire Discussion) instead. This feature will be available in an upcoming update!', 'info');
}

// Display search results
function displaySearchResults(users) {
    const searchResults = document.getElementById('search-results');
    
    if (users.length === 0) {
        searchResults.innerHTML = '<div class="no-results">No users found</div>';
        return;
    }
    
    let html = '';
    users.forEach(user => {
        const avatarUrl = getCachedAvatar(user.avatar, user.username);
        html += `
            <div class="search-result-item" onclick="startDM('${user.username}')">
                <div class="user-avatar">
                    <img src="${avatarUrl}" alt="${user.username}" onerror="handleAvatarError(this, '${user.username}')">
                </div>
                <div class="user-info">
                    <span class="username">${user.username}</span>
                    <span class="user-bio">${user.bio || 'Violinist'}</span>
                </div>
                <div class="start-chat-btn">
                    <i class="fas fa-comment"></i>
                </div>
            </div>
        `;
    });
    
    searchResults.innerHTML = html;
    searchResults.style.display = 'block';
}

// Modal functions
function openSearchModal() {
    document.getElementById('search-modal').style.display = 'block';
}

function closeSearchModal() {
    document.getElementById('search-modal').style.display = 'none';
}

function openSettingsModal() {
    document.getElementById('settings-modal').style.display = 'block';
}

function closeSettingsModal() {
    document.getElementById('settings-modal').style.display = 'none';
}

function openAdminModal() {
    document.getElementById('admin-modal').style.display = 'block';
}

function closeAdminModal() {
    document.getElementById('admin-modal').style.display = 'none';
}

// Chat FAQ functions
function toggleChatFAQ() {
    const modal = document.getElementById('chat-faq-modal');
    if (modal.style.display === 'block') {
        closeChatFAQ();
    } else {
        openChatFAQ();
    }
}

function openChatFAQ() {
    document.getElementById('chat-faq-modal').style.display = 'block';
}

function closeChatFAQ() {
    document.getElementById('chat-faq-modal').style.display = 'none';
}

function closeEmojiModal() {
    document.getElementById('emoji-modal').style.display = 'none';
}

function closeAttachmentModal() {
    document.getElementById('attachment-modal').style.display = 'none';
}

// Settings functions
function loadSettings() {
    const saved = localStorage.getItem('chatSettings');
    if (saved) {
        try {
            const settings = JSON.parse(saved);
            // Update UI with saved settings
            if (document.getElementById('sound-notifications')) {
                document.getElementById('sound-notifications').checked = settings.soundNotifications || false;
            }
            if (document.getElementById('desktop-notifications')) {
                document.getElementById('desktop-notifications').checked = settings.desktopNotifications || false;
            }
            if (document.getElementById('compact-mode')) {
                document.getElementById('compact-mode').checked = settings.compactMode || false;
            }
            if (document.getElementById('show-timestamps')) {
                document.getElementById('show-timestamps').checked = settings.showTimestamps || true;
            }
            if (document.getElementById('show-online-status')) {
                document.getElementById('show-online-status').checked = settings.showOnlineStatus || true;
            }
        } catch (e) {
            console.error('Error loading settings:', e);
        }
    }
}

function saveSettings() {
    const settings = {
        soundNotifications: document.getElementById('sound-notifications')?.checked || false,
        desktopNotifications: document.getElementById('desktop-notifications')?.checked || false,
        compactMode: document.getElementById('compact-mode')?.checked || false,
        showTimestamps: document.getElementById('show-timestamps')?.checked || true,
        showOnlineStatus: document.getElementById('show-online-status')?.checked || true
    };
    
    localStorage.setItem('chatSettings', JSON.stringify(settings));
    closeSettingsModal();
    showMessage('Settings saved successfully!', 'success');
}

// Admin functions
function clearAllMessages() {
    if (confirm('Are you sure you want to clear all messages? This action cannot be undone.')) {
        // Make API call to clear messages
        fetch('/admin/clear_messages', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('chat-messages').innerHTML = '';
                showMessage('All messages cleared', 'success');
            } else {
                showMessage('Error clearing messages: ' + data.message, 'error');
            }
        })
        .catch(error => {
            showMessage('Error clearing messages', 'error');
        });
        
        closeAdminModal();
    }
}

function muteUser() {
    const username = prompt('Enter username to mute:');
    if (username) {
        // Make API call to mute user
        showMessage(`User ${username} muted`, 'success');
    }
}

function banUser() {
    const username = prompt('Enter username to ban:');
    if (username) {
        // Make API call to ban user
        showMessage(`User ${username} banned`, 'success');
    }
}

function viewUserLogs() {
    showMessage('User logs feature coming soon', 'info');
}

// Utility functions
function viewUserProfile(username) {
    window.open(`/profile/${username}`, '_blank');
}

function editMessage(messageId) {
    const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
    if (!messageElement) return;
    
    const messageContent = messageElement.querySelector('.message-content');
    const currentText = messageContent.textContent;
    
    const newText = prompt('Edit message:', currentText);
    if (newText && newText !== currentText) {
        // Send edit request to server
        fetch('/edit_message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message_id: messageId,
                content: newText
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                messageContent.innerHTML = formatMessageContent(newText);
                showMessage('Message edited successfully!', 'success');
            } else {
                showMessage('Error editing message: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('Error editing message', 'error');
        });
    }
}

function deleteMessage(messageId) {
    if (confirm('Are you sure you want to delete this message?')) {
        // Send delete request to server
        fetch('/delete_message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message_id: messageId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove message from DOM
                const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
                if (messageElement) {
                    messageElement.remove();
                }
                showMessage('Message deleted successfully!', 'success');
            } else {
                showMessage('Error deleting message: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('Error deleting message', 'error');
        });
    }
}

function searchMessages() {
    const query = document.getElementById('message-search').value;
    if (!query) return;
    
    const results = messages.filter(msg => 
        msg.content.toLowerCase().includes(query.toLowerCase()) ||
        msg.sender.toLowerCase().includes(query.toLowerCase())
    );
    
    displaySearchResults(results);
}

// Play notification sound
function playNotificationSound() {
    // Create a simple notification sound
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
    oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
    
    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
    
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + 0.2);
}

// Check for new messages from other users
function checkForNewMessages() {
    if (currentRoom) {
        loadMessages(currentRoom, true);
    }
}

// Format message content to handle links and attachments
function formatMessageContent(content) {
    // Convert markdown-style links to HTML links or images
    const linkRegex = /\[([^\]]+)\]\(([^)]+)\)/g;
    let formattedContent = content.replace(linkRegex, function(match, text, url) {
        // Check if it's an image link
        if (text.startsWith('Image:') || url.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
            return `<img src="${url}" alt="${text}" class="message-image" onclick="openImageModal('${url}')" style="max-width: 200px; max-height: 200px; border-radius: 8px; cursor: pointer; margin: 5px 0;">`;
        } else {
            return `<a href="${url}" target="_blank" rel="noopener noreferrer" class="message-link">${text}</a>`;
        }
    });
    
    // Convert URLs to clickable links
    const urlRegex = /(https?:\/\/[^\s]+)/g;
    formattedContent = formattedContent.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener noreferrer" class="message-link">$1</a>');
    
    return formattedContent;
}

// Open image in modal for full view
function openImageModal(imageUrl) {
    // Create modal if it doesn't exist
    let modal = document.getElementById('image-modal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'image-modal';
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 90vw; max-height: 90vh; background: transparent; border: none;">
                <span class="close" onclick="closeImageModal()" style="color: white; font-size: 30px; position: absolute; top: 10px; right: 20px; cursor: pointer; z-index: 1001;">&times;</span>
                <img id="modal-image" src="" style="max-width: 100%; max-height: 100%; border-radius: 8px;">
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    // Set image source and show modal
    document.getElementById('modal-image').src = imageUrl;
    modal.style.display = 'block';
}

// Close image modal
function closeImageModal() {
    const modal = document.getElementById('image-modal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// Show message function
function showMessage(message, type) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message message-${type}`;
    messageDiv.textContent = message;
    messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        z-index: 1001;
        animation: slideIn 0.3s ease;
        background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8'};
    `;
    
    document.body.appendChild(messageDiv);
    
    setTimeout(() => {
        messageDiv.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => messageDiv.remove(), 300);
    }, 3000);
}

// Open emoji modal - Global function
window.toggleEmojiPicker = function() {
    console.log('Opening emoji modal');
    document.getElementById('emoji-modal').style.display = 'block';
    loadEmojis();
}

// Load emojis
function loadEmojis() {
    const emojiContainer = document.getElementById('emoji-modal-list');
    if (!emojiContainer) {
        console.error('Emoji container not found');
        return;
    }
    
    // Music and violin themed emojis plus common ones
    const emojis = [
        'üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'üòÇ', 'ü§£', 'üòä', 'üòá', 
        'üôÇ', 'üôÉ', 'üòâ', 'üòå', 'üòç', 'ü•∞', 'üòò', 'üòó', 'üòô', 'üòö', 
        'üòã', 'üòõ', 'üòù', 'üòú', 'ü§™', 'ü§®', 'üßê', 'ü§ì', 'üòé', 'ü§©', 
        'ü•≥', 'üòè', 'üòí', 'üòû', 'üòî', 'üòü', 'üòï', 'üôÅ', '‚òπÔ∏è', 'üò£', 
        'üòñ', 'üò´', 'üò©', 'ü•∫', 'üò¢', 'üò≠', 'üò§', 'üò†', 'üò°', 'ü§¨', 
        'ü§Ø', 'üò≥', 'ü•µ', 'ü•∂', 'üò±', 'üò®', 'üò∞', 'üò•', 'üòì', 'ü§ó', 
        'ü§î', 'ü§≠', 'ü§´', 'ü§•', 'üò∂', 'üòê', 'üòë', 'üòØ', 'üò¶', 'üòß', 
        'üòÆ', 'üò≤', 'ü•±', 'üò¥', 'ü§§', 'üò™', 'üòµ', 'ü§ê', 'ü•¥', 'ü§¢', 
        'ü§Æ', 'ü§ß', 'üò∑', 'ü§í', 'ü§ï', 'ü§ë', 'ü§†', 
        'üéª', 'üéº', 'üéµ', 'üé∂', 'üé§', 'üéß', 'üé∫', 'üé∑', 'üé∏', 'üéπ', 
        'ü•Å', 'üéØ', 'üé≤', 'üéÆ', 'üé∞', 'üé≥', 'üé®', 'üé¨', 'üé≠', 'üé™', 
        'üéüÔ∏è', 'üé´', 'üéóÔ∏è', 'üéñÔ∏è', 'üèÜ', 'üèÖ', 'ü•á', 'ü•à', 'ü•â', 'üéä', 
        'üéâ', 'üéà', 'üéÇ', 'üéÅ', 'üéÑ', 'üéÉ', 'üëç', 'üëé', 'üëå', '‚úåÔ∏è', 
        'ü§û', 'ü§ü', 'ü§ò', 'ü§ô', 'üëà', 'üëâ', 'üëÜ', 'üëá', '‚òùÔ∏è', '‚úã', 
        'ü§ö', 'üñêÔ∏è', 'üññ', 'üëã', 'ü§ù', 'üëè', 'üôå', 'üëê', 'ü§≤', 'ü§ú', 
        'ü§õ', '‚úä', 'üëä', 'üëé', 'üëç', '‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 
        'üíú', 'üñ§', 'ü§ç', 'ü§é', 'üíî', '‚ù£Ô∏è', 'üíï', 'üíû', 'üíì', 'üíó', 
        'üíñ', 'üíò', 'üíù', 'üíü', '‚òÆÔ∏è', '‚úùÔ∏è', '‚ò™Ô∏è', 'üïâÔ∏è', '‚ò∏Ô∏è', '‚ú°Ô∏è', 
        'üîØ', 'üïé', '‚òØÔ∏è', '‚ò¶Ô∏è', 'üõê', '‚õé', '‚ôà', '‚ôâ', '‚ôä', '‚ôã', 
        '‚ôå', '‚ôç', '‚ôé', '‚ôè', '‚ôê', '‚ôë', '‚ôí', '‚ôì', 'üÜî', '‚öõÔ∏è', 
        'üâë', '‚ò¢Ô∏è', '‚ò£Ô∏è', 'üì¥', 'üì≥', 'üà∂', 'üàö', 'üà∏', 'üà∫', 'üà∑Ô∏è', 
        '‚ú¥Ô∏è', 'üÜö', 'üíÆ', 'üâê', '„äôÔ∏è', '„äóÔ∏è', 'üà¥', 'üàµ', 'üàπ', 'üà≤', 
        'üÖ∞Ô∏è', 'üÖ±Ô∏è', 'üÜé', 'üÜë', 'üÖæÔ∏è', 'üÜò', '‚ùå', '‚≠ï', 'üõë', '‚õî', 
        'üìõ', 'üö´', 'üíØ', 'üí¢', '‚ô®Ô∏è', 'üö∑', 'üöØ', 'üö≥', 'üö±', 'üîû', 
        'üìµ', 'üö≠', '‚ùó', '‚ùï', '‚ùì', '‚ùî', '‚ÄºÔ∏è', '‚ÅâÔ∏è', 'üîÖ', 'üîÜ', 
        '„ÄΩÔ∏è', '‚ö†Ô∏è', 'üö∏', 'üî±', '‚öúÔ∏è', 'üî∞', '‚ôªÔ∏è', '‚úÖ', 'üàØ', 'üíπ', 
        '‚ùáÔ∏è', '‚ú≥Ô∏è', '‚ùé', 'üåê', 'üí†', '‚ìÇÔ∏è', 'üåÄ', 'üí§', 'üèß', 'üöæ', 
        '‚ôø', 'üÖøÔ∏è', 'üà≥', 'üàÇÔ∏è', 'üõÇ', 'üõÉ', 'üõÑ', 'üõÖ', 'üöπ', 'üö∫', 
        'üöº', 'üöª', 'üöÆ', 'üé¶', 'üì∂', 'üàÅ', 'üî£', '‚ÑπÔ∏è', 'üî§', 'üî°', 
        'üî†', 'üÜñ', 'üÜó', 'üÜô', 'üÜí', 'üÜï', 'üÜì', '0Ô∏è‚É£', '1Ô∏è‚É£', '2Ô∏è‚É£', 
        '3Ô∏è‚É£', '4Ô∏è‚É£', '5Ô∏è‚É£', '6Ô∏è‚É£', '7Ô∏è‚É£', '8Ô∏è‚É£', '9Ô∏è‚É£', 'üîü'
    ];
    
    emojiContainer.innerHTML = '';
    emojis.forEach(emoji => {
        const emojiSpan = document.createElement('span');
        emojiSpan.className = 'emoji';
        emojiSpan.textContent = emoji;
        emojiSpan.onclick = () => insertEmoji(emoji);
        emojiContainer.appendChild(emojiSpan);
    });
}

// Insert emoji into message input
function insertEmoji(emoji) {
    const messageInput = document.getElementById('message-input');
    if (messageInput) {
        messageInput.value += emoji;
        messageInput.focus();
    }
    closeEmojiModal();
}

// Open attachment modal - Global function
window.toggleAttachmentMenu = function() {
    console.log('Opening attachment modal');
    document.getElementById('attachment-modal').style.display = 'block';
}

// Open file picker for different file types
function openFilePicker(type) {
    const fileInput = document.getElementById('file-input');
    
    // Set accept attribute based on type
    switch(type) {
        case 'image':
            fileInput.accept = 'image/*';
            break;
        case 'video':
            fileInput.accept = 'video/*';
            break;
        case 'audio':
            fileInput.accept = 'audio/*';
            break;
        case 'document':
            fileInput.accept = '.pdf,.doc,.docx,.txt,.rtf';
            break;
        default:
            fileInput.accept = '*/*';
    }
    
    // Clear previous files
    fileInput.value = '';
    
    // Open file picker
    fileInput.click();
    
    // Close modal
    closeAttachmentModal();
}

// Handle file selection
document.getElementById('file-input').addEventListener('change', function(e) {
    const files = e.target.files;
    if (files.length > 0) {
        handleFileUpload(files);
    }
});

// Handle file upload
function handleFileUpload(files) {
    const messageInput = document.getElementById('message-input');
    
    for (let file of files) {
        uploadFile(file, messageInput);
    }
}

// Upload file to server
function uploadFile(file, messageInput) {
    const formData = new FormData();
    formData.append('file', file);
    
    // Show upload progress
    const fileIcon = getFileIcon(file.type);
    const tempText = ` ${fileIcon} Uploading ${file.name}...`;
    messageInput.value += tempText;
    
    fetch('/upload_chat_file', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove the "Uploading..." text
            messageInput.value = messageInput.value.replace(tempText, '');
            
            // Add the actual file link
            const fileType = getFileType(file.type);
            const fileIcon = getFileIcon(file.type);
            
            if (fileType === 'Image') {
                // For images, add a clickable link that will display the image
                const fileLink = ` ${fileIcon} [Image: ${file.name}](${data.file_url})`;
                messageInput.value += fileLink;
            } else {
                // For other files, add a download link
                const fileLink = ` ${fileIcon} [${fileType}: ${file.name}](${data.file_url})`;
                messageInput.value += fileLink;
            }
        } else {
            // Remove the "Uploading..." text and show error
            messageInput.value = messageInput.value.replace(tempText, '');
            messageInput.value += ` ‚ùå Upload failed: ${data.message}`;
        }
    })
    .catch(error => {
        // Remove the "Uploading..." text and show error
        messageInput.value = messageInput.value.replace(tempText, '');
        messageInput.value += ` ‚ùå Upload failed: ${error.message}`;
    });
}

// Get file type category
function getFileType(mimeType) {
    if (mimeType.startsWith('image/')) return 'Image';
    if (mimeType.startsWith('video/')) return 'Video';
    if (mimeType.startsWith('audio/')) return 'Audio';
    if (mimeType.includes('pdf')) return 'PDF';
    if (mimeType.includes('word') || mimeType.includes('document')) return 'Document';
    if (mimeType.includes('text')) return 'Text';
    return 'File';
}

// Get appropriate icon for file type
function getFileIcon(mimeType) {
    if (mimeType.startsWith('image/')) return 'üñºÔ∏è';
    if (mimeType.startsWith('video/')) return 'üé•';
    if (mimeType.startsWith('audio/')) return 'üéµ';
    if (mimeType.includes('pdf')) return 'üìÑ';
    if (mimeType.includes('word') || mimeType.includes('document')) return 'üìù';
    if (mimeType.includes('text')) return 'üìÑ';
    return 'üìé';
}

// Close emoji picker and attachment menu when clicking outside
document.addEventListener('click', function(event) {
    const emojiPicker = document.getElementById('emoji-picker');
    const attachmentMenu = document.getElementById('attachment-menu');
    
    if (emojiPicker && !event.target.closest('.emoji-picker') && !event.target.closest('#emoji-btn')) {
        emojiPicker.style.display = 'none';
    }
    
    if (attachmentMenu && !event.target.closest('.attachment-menu') && !event.target.closest('#attach-btn')) {
        attachmentMenu.style.display = 'none';
    }
});
</script>
{% endblock %}